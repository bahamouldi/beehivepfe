input {
  # Receive logs from Docker via TCP
  tcp {
    port => 5044
    codec => json_lines
  }
  
  # Also accept logs via UDP for high-volume scenarios
  udp {
    port => 5044
    codec => json_lines
  }
}

filter {
  # Add service identifier if not present
  if ![service] {
    mutate {
      add_field => { "service" => "beewaf" }
    }
  }
  
  # Parse timestamp
  if [@timestamp] {
    date {
      match => [ "@timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }
  
  # Enrich blocked events
  if [event] == "blocked" {
    mutate {
      add_tag => [ "security", "blocked" ]
    }
    
    # Categorize attack types
    if [reason] == "regex-sqli" {
      mutate {
        add_field => { "attack_type" => "SQL Injection" }
        add_tag => [ "sqli" ]
      }
    } else if [reason] == "regex-xss" {
      mutate {
        add_field => { "attack_type" => "Cross-Site Scripting" }
        add_tag => [ "xss" ]
      }
    } else if [reason] == "regex-path-traversal" {
      mutate {
        add_field => { "attack_type" => "Path Traversal" }
        add_tag => [ "path-traversal" ]
      }
    } else if [reason] == "regex-cmd-injection" {
      mutate {
        add_field => { "attack_type" => "Command Injection" }
        add_tag => [ "cmd-injection" ]
      }
    } else if [reason] == "rate-limit" {
      mutate {
        add_field => { "attack_type" => "Rate Limit Exceeded" }
        add_tag => [ "rate-limit" ]
      }
    } else if [reason] == "anomaly" {
      mutate {
        add_field => { "attack_type" => "ML Anomaly Detected" }
        add_tag => [ "anomaly", "ml" ]
      }
    }
  }
  
  # GeoIP lookup for client IPs (if you have GeoIP database)
  if [client_ip] and [client_ip] != "unknown" and [client_ip] !~ /^(127\.|10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[01])\.)/ {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
  
  # Calculate request rate (for dashboards)
  if [event] == "request" or [event] == "blocked" {
    mutate {
      add_field => { "request_count" => 1 }
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "beewaf-logs-%{+YYYY.MM.dd}"
    template_name => "beewaf"
    template_overwrite => true
  }
  
  # Debug output (disable in production)
  # stdout { codec => rubydebug }
}
